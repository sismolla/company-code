{% extends 'base2.html' %}
{% load static %}

{% block style %}
<style>
    /* Enhanced Product Grid Styles */
    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 24px;
        padding: 20px 0;
    }

    .product-card-link {
        text-decoration: none;
        color: inherit;
        display: block;
        height: 100%;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .product-card-link:hover {
        transform: translateY(-5px);
        text-decoration: none;
    }

    .product-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .product-card:hover {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .product-image {
        height: 200px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }

    .product-real-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .product-card:hover .product-real-image {
        transform: scale(1.05);
    }

    .product-image .fas {
        font-size: 3rem;
        color: #6c757d;
        opacity: 0.7;
    }

    .product-details {
        padding: 20px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }

    .product-category {
        font-size: 0.8rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
        font-weight: 600;
    }

    .product-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0 0 12px 0;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .product-price {
        font-size: 1.4rem;
        font-weight: 700;
        color: #3498db;
        margin: 0 0 12px 0;
    }

    /* Review Stars Styles */
    .product-reviews {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
    }

    .star-rating {
        display: flex;
        margin-right: 8px;
    }

    .star {
        color: #ddd;
        font-size: 14px;
        margin-right: 2px;
    }

    .star.filled {
        color: #FFD700;
    }

    .star.half {
        position: relative;
    }

    .star.half:before {
        content: '★';
        position: absolute;
        left: 0;
        width: 50%;
        overflow: hidden;
        color: #FFD700;
    }

    .review-count {
        font-size: 0.85rem;
        color: #6c757d;
    }

    .product-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: auto;
        padding-top: 15px;
        border-top: 1px solid #f1f3f5;
    }

    .product-meta span:first-child {
        font-size: 0.9rem;
        color: #6c757d;
    }

    .product-meta span:last-child {
        font-size: 0.85rem;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 20px;
    }

    .in-stock {
        background-color: #d4edda;
        color: #155724;
    }

    .out-of-stock {
        background-color: #f8d7da;
        color: #721c24;
    }

    /* Loading states */
    .loading-message {
        text-align: center;
        padding: 40px;
        color: #6c757d;
        font-size: 1.1rem;
        grid-column: 1 / -1;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .products-grid {
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 16px;
        }
        
        .product-image {
            height: 180px;
        }
        
        .product-title {
            font-size: 1rem;
        }
        
        .product-price {
            font-size: 1.25rem;
        }
    }

    @media (max-width: 480px) {
        .products-grid {
            grid-template-columns: 1fr;
            gap: 12px;
        }
    }

    /* Animation for new products */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .product-card {
        animation: fadeInUp 0.5s ease forwards;
    }
</style>
{% endblock style %}

{% block content %}
<main class="main-container">
    <div class="filter-section">
        <div class="filter-group">
            <h3>Categories</h3>
            <div class="filter-options" id="filter-options-container">
                <div class="filter-chip active" data-filter-id="">All</div>
            </div>
        </div>
        
        <div class="filter-group">
            <h3>Price Range ($)</h3>
            <div class="price-range-container">
                <div class="price-display">
                    <span id="min-price-display">$0</span>
                    <span id="max-price-display">$1000</span>
                </div>
                <div class="slider-container" style="position: relative; height: 8px; margin: 10px 0;">
                    <div id="slider-track" style="position: absolute; height: 8px; background: #3b82f6; border-radius: 4px; left:0; width:100%;"></div>
                    <input type="range" class="range-slider" id="min-price-slider" min="0" max="1000" value="0" step="10" style="position: absolute; width: 100%; top: -6px; pointer-events: all; background: none;">
                    <input type="range" class="range-slider" id="max-price-slider" min="0" max="1000" value="1000" step="10" style="position: absolute; width: 100%; top: -6px; pointer-events: all; background: none;">
                </div>
                <button class="btn" id="apply-price-filter">Apply</button>
            </div>
        </div>
    </div>
    
    <div class="products-header">
        <h2>Available Products <span class="products-count" id="products-count">(0 listings)</span></h2>
        <div class="sort-options">
            <select id="sort-select">
                <option value="">Sort by: Default</option>
                <option value="price">Price: Low to High</option>
                <option value="-price">Price: High to Low</option>
                <option value="name">Name: A-Z</option>
                <option value="-name">Name: Z-A</option>
                <option value="stock_quantity">Stock: Low to High</option>
                <option value="-stock_quantity">Stock: High to Low</option>
                <option value="-avg_rating">Rating: High to Low</option>
                <option value="avg_rating">Rating: Low to High</option>
            </select>
        </div>
    </div>
    
    <div class="products-grid" id="products-grid">
        <p class="loading-message">Loading products... if it takes long please refresh the page</p>
    </div>

    <!-- Loader for Infinite Scroll -->
    <div id="products-loader" style="display:none; text-align:center; margin:20px 0; font-weight:bold; color:#555;">
        <div style="
            display:inline-block;
            width:24px;
            height:24px;
            border:3px solid rgba(0,0,0,0.2);
            border-top-color:#333;
            border-radius:50%;
            animation: spin 1s linear infinite;
            margin-right:8px;
            vertical-align: middle;
        "></div>
        Loading more products...
    </div>
</main>

<script>
    // Inline keyframes for spinner
    const style = document.createElement('style');
    style.innerHTML = `
        @keyframes spin { to { transform: rotate(360deg); } }
    `;
    document.head.appendChild(style);
</script>
{% endblock content %}

{% block script %}
<script>
    // === API Endpoints ===
    const PRODUCT_API_URL = 'http://127.0.0.1:8000/product/api/';
    const DOSAGE_API_URL = 'http://127.0.0.1:8000/dosage/api/';

    const productsGrid = document.getElementById('products-grid');
    const productsCountSpan = document.getElementById('products-count');
    const filterOptionsContainer = document.getElementById('filter-options-container');
    const minPriceSlider = document.getElementById('min-price-slider');
    const maxPriceSlider = document.getElementById('max-price-slider');
    const minPriceDisplay = document.getElementById('min-price-display');
    const maxPriceDisplay = document.getElementById('max-price-display');
    const applyPriceFilterButton = document.getElementById('apply-price-filter');
    const sortSelect = document.getElementById('sort-select');
    const sliderTrack = document.getElementById('slider-track');
    const loader = document.getElementById('products-loader');

    const priceMin = minPriceSlider ? parseInt(minPriceSlider.min) : 0;
    const priceMax = maxPriceSlider ? parseInt(maxPriceSlider.max) : 1000;

    const dosageFormIcons = {
        'Tablet':'fa-tablets','Capsule':'fa-capsules','Syrup':'fa-prescription-bottle-alt',
        'Injection':'fa-syringe','Suspension':'fa-prescription-bottle-alt','Cream':'fa-mortar-pestle',
        'Ointment':'fa-mortar-pestle','Gel':'fa-mortar-pestle','Lotion':'fa-mortar-pestle',
        'Suppository':'fa-pills','Powder':'fa-pills','Drops (Eye/Ear/Nasal)':'fa-eyedropper',
        'Inhaler':'fa-inhaler','Patch':'fa-band-aid','Granules':'fa-pills','Mouthwash':'fa-bottle-water',
        'Lozenge':'fa-pills','Solution':'fa-prescription-bottle-alt','Emulsion':'fa-prescription-bottle-alt',
        'Spray':'fa-spray-can','default':'fa-pills'
    };

    let currentFilters = { dosage_form:'', search:'', price__gte:priceMin, price__lte:priceMax, ordering:'price' };
    let currentPage=1, isFetching=false, hasNextPage=true;

    function buildApiUrl(page=1){
        const params=new URLSearchParams();
        if(currentFilters.dosage_form) params.append('dosage_form', currentFilters.dosage_form);
        if(currentFilters.search) params.append('search', currentFilters.search);
        if(currentFilters.price__gte!==priceMin) params.append('price__gte', currentFilters.price__gte);
        if(currentFilters.price__lte!==priceMax) params.append('price__lte', currentFilters.price__lte);
        if(currentFilters.ordering) params.append('ordering', currentFilters.ordering);
        params.append('page', page);
        return `${PRODUCT_API_URL}?${params.toString()}`;
    }

    // Function to render star ratings
    function renderStarRating(rating) {
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;
        const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
        
        let starsHTML = '';
        
        // Full stars
        for (let i = 0; i < fullStars; i++) {
            starsHTML += '<span class="star filled">★</span>';
        }
        
        // Half star
        if (hasHalfStar) {
            starsHTML += '<span class="star half">★</span>';
        }
        
        // Empty stars
        for (let i = 0; i < emptyStars; i++) {
            starsHTML += '<span class="star">★</span>';
        }
        
        return starsHTML;
    }

    const searchInput = document.getElementById('search-input');
        if(searchInput){
            searchInput.addEventListener('input', (e)=>{
                currentFilters.search = e.target.value.trim();
                currentPage = 1;
                hasNextPage = true;
                fetchProducts();
            });
        }

    function renderProducts(products, append=false){
        if(!productsGrid) return;
        if(!append) productsGrid.innerHTML='';
        if(!products || products.length===0){ if(!append) productsGrid.innerHTML='<p class="loading-message">No products found matching your criteria.</p>'; return; }
        
        products.forEach(p=>{
            const imgContent=p.image ? `<img src="${p.image}" alt="${p.name}" class="product-real-image">` 
            : `<i class="fas ${dosageFormIcons[p.dosage_form_name]||dosageFormIcons['default']}"></i>`;
            
            const stockClass=p.stock_quantity>0?'in-stock':'out-of-stock';
            const stockText=p.stock_quantity>0?'In Stock':'Out of Stock';
            
            // Calculate average rating if reviews exist
            let reviewsHTML = '';
            if (p.reviews && p.reviews.length > 0) {
                const totalRating = p.reviews.reduce((sum, review) => sum + review.rating, 0);
                const avgRating = totalRating / p.reviews.length;
                const roundedRating = Math.round(avgRating * 10) / 10; // Round to 1 decimal place
                
                reviewsHTML = `
                    <div class="product-reviews">
                        <div class="star-rating">
                            ${renderStarRating(avgRating)}
                        </div>
                        <span class="review-count">(${p.reviews.length})</span>
                    </div>
                `;
            } else {
                reviewsHTML = `
                    <div class="product-reviews">
                        <div class="star-rating">
                            <span class="star">★</span>
                            <span class="star">★</span>
                            <span class="star">★</span>
                            <span class="star">★</span>
                            <span class="star">★</span>
                        </div>
                        <span class="review-count">(0)</span>
                    </div>
                `;
            }
            
            const card=`<a href="/product/detail/${p.id}/" class="product-card-link">
                <div class="product-card">
                    <div class="product-image">${imgContent}</div>
                    <div class="product-details">
                        <div class="product-category">${p.dosage_form_name||''}</div>
                        <h3 class="product-title">${p.name||''} ${p.strength||''}</h3>
                        <div class="product-price">$${p.price||0}</div>
                        ${reviewsHTML}
                        <div class="product-meta">
                            <span>Available: ${p.stock_quantity||0}+</span>
                            <span class="${stockClass}">${stockText}</span>
                        </div>
                    </div>
                </div>
            </a>`;
            
            if (append) {
                productsGrid.innerHTML += card;
            } else {
                // For initial load, add with animation delay based on index
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = card;
                const cardElement = tempDiv.firstElementChild;
                productsGrid.appendChild(cardElement);
            }
        });
    }

    async function fetchProducts(page=1, append=false){
        if(isFetching || !hasNextPage) return;
        isFetching=true;
        if(!append){ productsGrid.innerHTML='<p class="loading-message">Loading products...</p>'; productsCountSpan.textContent='(loading...)'; }
        else if(loader) loader.style.display='block';

        try{
            const res=await fetch(buildApiUrl(page));
            if(!res.ok) throw new Error('Network error');
            const data=await res.json();
            renderProducts(data.results, append);
            productsCountSpan.textContent=`(${data.count||0} listings)`;
            hasNextPage=!!data.next; currentPage=page;
        }catch(e){ console.error(e); }
        finally{ isFetching=false; if(loader) loader.style.display='none'; }
    }

    window.addEventListener('scroll', ()=>{
        if(window.innerHeight+window.scrollY>=document.body.offsetHeight-150){
            if(!isFetching && hasNextPage) fetchProducts(currentPage+1,true);
        }
    });

    async function fetchDosageForms(){
        if(!filterOptionsContainer) return;
        try{
            const res=await fetch(DOSAGE_API_URL);
            const data=await res.json();
            const allChip=document.querySelector('[data-filter-id=""]');
            filterOptionsContainer.innerHTML='';
            if(allChip) filterOptionsContainer.appendChild(allChip);
            data.forEach(f=>{
                const chip=document.createElement('div');
                chip.className='filter-chip'; chip.textContent=f.name||''; chip.dataset.filterId=f.id;
                chip.addEventListener('click',()=>{
                    document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active'));
                    chip.classList.add('active'); currentFilters.dosage_form=f.id; currentPage=1; hasNextPage=true; fetchProducts();
                });
                filterOptionsContainer.appendChild(chip);
            });
        }catch(e){ console.error(e); }
    }

    function updateSliderTrack(){
        if(!sliderTrack || !minPriceSlider || !maxPriceSlider) return;
        let minVal=parseInt(minPriceSlider.value||priceMin);
        let maxVal=parseInt(maxPriceSlider.value||priceMax);
        sliderTrack.style.left=((minVal-priceMin)/(priceMax-priceMin))*100+'%';
        sliderTrack.style.width=(((maxVal-minVal)/(priceMax-priceMin))*100)+'%';
    }

    if(minPriceSlider) minPriceSlider.addEventListener('input',()=>{ let minVal=parseInt(minPriceSlider.value); let maxVal=parseInt(maxPriceSlider.value); if(minVal>maxVal) minPriceSlider.value=minVal=maxVal; minPriceDisplay.textContent=`$${minVal}`; updateSliderTrack(); });
    if(maxPriceSlider) maxPriceSlider.addEventListener('input',()=>{ let maxVal=parseInt(maxPriceSlider.value); let minVal=parseInt(minPriceSlider.value); if(maxVal<minVal) maxPriceSlider.value=maxVal=minVal; maxPriceDisplay.textContent=`$${maxVal}`; updateSliderTrack(); });

    if(applyPriceFilterButton) applyPriceFilterButton.addEventListener('click',()=>{ currentFilters.price__gte=minPriceSlider.value; currentFilters.price__lte=maxPriceSlider.value; currentPage=1; hasNextPage=true; fetchProducts(); });
    if(sortSelect) sortSelect.addEventListener('change',(e)=>{ currentFilters.ordering=e.target.value; currentPage=1; hasNextPage=true; fetchProducts(); });

    const allChip=document.querySelector('[data-filter-id=""]');
    if(allChip) allChip.addEventListener('click',e=>{ document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active')); e.target.classList.add('active'); currentFilters.dosage_form=''; currentPage=1; hasNextPage=true; fetchProducts(); });

    window.addEventListener('load',async()=>{ await fetchDosageForms(); await fetchProducts(); updateSliderTrack(); });
</script>
{% endblock script %}