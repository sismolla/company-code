{% extends 'base.html' %}
{% load static %}

{% block style %}
<style>
    :root {
        --primary: #4361ee;
        --primary-dark: #3a56d4;
        --primary-light: #e6e9ff;
        --success: #06d6a0;
        --warning: #ffd166;
        --danger: #ef476f;
        --info: #118ab2;
        --background: #f8f9fa;
        --card-bg: #ffffff;
        --text-color: #2b2d42;
        --secondary-text: #6c757d;
        --border-color: #e9ecef;
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
        --radius-sm: 6px;
        --radius-md: 12px;
        --radius-lg: 16px;
        --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }


    .dashboard {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    .dashboard-header-header {
        margin-bottom: 2.5rem;
        text-align: center;
    }

    .dashboard-title {
        font-size: 2.25rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--primary);
        background: linear-gradient(90deg, var(--primary), #5e35b1);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .dashboard-subtitle {
        color: var(--secondary-text);
        font-size: 1.1rem;
        max-width: 600px;
        margin: 0 auto;
    }

    .dashboard-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .search-container {
        position: relative;
        flex: 1;
        min-width: 250px;
    }

    .search-input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.75rem;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
        background-color: var(--card-bg);
        font-size: 0.95rem;
        transition: var(--transition);
        box-shadow: var(--shadow-sm);
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--secondary-text);
    }

    .filter-group {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .filter-label {
        font-size: 0.9rem;
        color: var(--secondary-text);
        font-weight: 500;
    }

    .filter-select {
        padding: 0.75rem;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
        background-color: var(--card-bg);
        font-size: 0.9rem;
        cursor: pointer;
        transition: var(--transition);
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--primary);
    }

    .orders-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
    }

    .order-card {
        background-color: var(--card-bg);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-md);
        overflow: hidden;
        transition: var(--transition);
        border-left: 4px solid var(--border-color);
        position: relative;
    }

    .important-notes {
        background-color: var(--primary-light);
        border-radius: var(--radius-md);
        padding: 1.5rem;
        margin-top: 2rem;
        box-shadow: var(--shadow-sm);
    }

    .notes-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .notes-icon {
        color: var(--primary);
        font-size: 1.5rem;
    }

    .notes-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--primary);
        margin: 0;
    }

    .notes-list {
        list-style: none;
        padding-left: 0;
        margin: 0;
    }

    .notes-list li {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        font-size: 0.95rem;
        color: var(--text-color);
        margin-bottom: 0.75rem;
    }

    .notes-list li:last-child {
        margin-bottom: 0;
    }

    .notes-list li::before {
        content: '\f05a'; /* Font Awesome 'info-circle' icon */
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        color: var(--info);
        flex-shrink: 0;
        margin-top: 0.15rem;
    }
    
    /* Responsive Adjustments */
    @media (max-width: 768px) {
        /* ... (your existing media query) ... */
        .important-notes {
            padding: 1rem;
        }
        .notes-title {
            font-size: 1.1rem;
        }
        .notes-list li {
            font-size: 0.9rem;
        }
    }

    .order-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .order-status {
        position: absolute;
        top: 1rem;
        right: 1rem;
        padding: 0.35rem 0.75rem;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: white;
    }

    .order-header {
        padding: 1.5rem 1.5rem 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .order-id {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
        color: var(--primary);
    }

    .order-date {
        font-size: 0.85rem;
        color: var(--secondary-text);
    }

    .order-body {
        padding: 1.25rem 1.5rem;
    }

    .order-customer {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .customer-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--primary-light);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary);
        font-weight: 600;
    }

    .customer-info h4 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
    }

    .customer-info p {
        margin: 0.25rem 0 0;
        font-size: 0.85rem;
        color: var(--secondary-text);
    }

    .order-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 1rem;
    }

    .detail-item {
        display: flex;
        flex-direction: column;
    }

    .detail-label {
        font-size: 0.75rem;
        color: var(--secondary-text);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }

    .detail-value {
        font-size: 0.95rem;
        font-weight: 500;
    }

    .order-items {
        margin-top: 1rem;
    }

    .order-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px dashed var(--border-color);
    }

    .order-item:last-child {
        border-bottom: none;
    }

    .order-item-name {
        font-weight: 500;
    }

    .order-item-qty {
        color: var(--secondary-text);
    }

    .order-total {
        font-weight: 600;
        color: var(--primary);
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
    }

    .order-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
    }

    .btn {
        padding: 0.65rem 1.25rem;
        border-radius: var(--radius-sm);
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background-color: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        background-color: var(--primary-dark);
    }

    .btn-outline {
        background-color: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-color);
    }

    .btn-outline:hover {
        background-color: var(--background);
    }

    .btn-danger {
        background-color: var(--danger);
        color: white;
    }

    .btn-danger:hover {
        background-color: #d2335c;
    }

    /* Status Colors */
    .status-pending {
        background-color: var(--warning);
    }

    .status-confirmed {
        background-color: var(--success);
    }

    .status-canceled {
        background-color: var(--danger);
    }

    /* Empty State */
    .empty-state {
        grid-column: 1 / -1;
        text-align: center;
        padding: 3rem;
        background-color: var(--card-bg);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
    }

    .empty-icon {
        font-size: 3rem;
        color: var(--secondary-text);
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-title {
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
        color: var(--text-color);
    }

    .empty-text {
        color: var(--secondary-text);
        max-width: 400px;
        margin: 0 auto;
    }

    /* Loading State */
    .loader-container {
        grid-column: 1 / -1;
        text-align: center;
        padding: 3rem;
    }

    .loader {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid var(--primary-light);
        border-radius: 50%;
        border-top-color: var(--primary);
        animation: spin 1s ease-in-out infinite;
    }

    .loader-text {
        margin-top: 1rem;
        color: var(--secondary-text);
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Toast Notification */
    .toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        padding: 1rem 1.5rem;
        border-radius: var(--radius-md);
        background-color: var(--text-color);
        color: white;
        box-shadow: var(--shadow-lg);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        z-index: 1000;
        transform: translateY(20px);
        opacity: 0;
        transition: var(--transition);
    }

    .toast.show {
        transform: translateY(0);
        opacity: 1;
    }

    .toast-success {
        background-color: var(--success);
    }

    .toast-error {
        background-color: var(--danger);
    }

    .toast-info {
        background-color: var(--info);
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .dashboard {
            padding: 1.5rem;
        }
        
        .dashboard-title {
            font-size: 1.75rem;
        }
        
        .dashboard-controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        .orders-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 480px) {
        .dashboard {
            padding: 1rem;
        }
        
        .order-details {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock style %}

{% block content %}
<div class="dashboard">
     <header class="dashboard-header-header">
        <h1 class="dashboard-title">Order Management</h1>
        <p class="dashboard-subtitle">Review and manage all customer orders in one place.</p>
        
        <div class="important-notes">
            <div class="notes-header">
                <i class="fas fa-exclamation-triangle notes-icon"></i>
                <h2 class="notes-title">Important Notes</h2>
            </div>
            <ul class="notes-list">
                <li>
                    Orders have a maximum lifespan of one week (7 days) and are automatically deleted by the system afterward.
                </li>
                <li>
                    Once an order is canceled, it's no longer displayed to you, and an email notification is sent to the customer.
                </li>
                <li>
                    When an order is confirmed, the system automatically sends an acceptance email to the customer, and the available stock for the ordered products is reduced until you update it. The supplier is also notified of this change.
                </li>
                <li>
                    Please note that until an order is responded to (confirmed or canceled), the stock promotion calculation is based on the updated quantity. For example, if the original stock is 20 and a customer orders 15, the promotion is applied to the remaining 5, not the original 20.
                </li>
            </ul>
        </div>
        </header>

    <div class="dashboard-controls">
        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" placeholder="Search orders..." id="order-search">
        </div>
        <div class="filter-group">
            <span class="filter-label">Status:</span>
            <select class="filter-select" id="status-filter">
                <option value="all">All Orders</option>
                <option value="pending">Pending</option>
                <option value="confirmed">Confirmed</option>
                <option value="cancelled">Canceled</option>
            </select>
        </div>
    </div>

    <div class="orders-grid" id="orders-container">
        <div class="loader-container">
            <div class="loader"></div>
            <p class="loader-text">Loading orders...</p>
        </div>
    </div>
    
    <div class="view-more-link" style="text-align: center; margin-top: 20px; display: none;" id="view-more-container">
        <a href="#" class="btn btn-outline" id="view-all-orders">View All Orders</a>
    </div>
</div>

<div class="toast" id="toast-notification">
    <i class="fas fa-check-circle"></i>
    <span id="toast-message">Order updated successfully</span>
</div>
{% endblock content %}

{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ordersContainer = document.getElementById('orders-container');
        const searchInput = document.getElementById('order-search');
        const statusFilter = document.getElementById('status-filter');
        const toast = document.getElementById('toast-notification');
        const toastMessage = document.getElementById('toast-message');
        const viewMoreContainer = document.getElementById('view-more-container');
        
        let allOrders = []; // Store the full list of orders

        // Format date
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return new Date(dateString).toLocaleDateString('en-US', options);
        }

        // Get initials for avatar
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase();
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            toast.className = `toast toast-${type} show`;
            toastMessage.textContent = message;
            
            // Update icon based on type
            const icon = toast.querySelector('i');
            if (type === 'success') {
                icon.className = 'fas fa-check-circle';
            } else if (type === 'error') {
                icon.className = 'fas fa-exclamation-circle';
            } else {
                icon.className = 'fas fa-info-circle';
            }
            
            // Hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Create order card HTML
        function createOrderCard(order) {
            const statusText = order.status.charAt(0).toUpperCase() + order.status.slice(1);
            const initials = getInitials(order.customer_full_name);
            
            // Calculate total amount directly from the price field
            const totalAmount = order.items.reduce((sum, item) => sum + (parseFloat(item.product_price) * parseInt(item.quantity)), 0).toFixed(2);
            
            // Determine actions based on status
            let actions = '';
            if (order.status === 'pending') {
                actions = `
                    <button class="btn btn-outline" onclick="viewOrderDetails('${order.id}')">
                        <i class="fas fa-eye"></i> View
                    </button>
                    <button class="btn btn-primary" onclick="confirmOrder('${order.id}')">
                        <i class="fas fa-check"></i> Confirm
                    </button>
                    <button class="btn btn-danger" onclick="cancelOrder('${order.id}')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                `;
            } else if (order.status === 'confirmed' || order.status === 'cancelled') {
                actions = `
                    <button class="btn btn-outline" onclick="viewOrderDetails('${order.id}')">
                        <i class="fas fa-eye"></i> View
                    </button>
                `;
            }
            
            // Create items list HTML
            const itemsHtml = order.items.map(item => `
                <div class="order-item">
                    <div>
                        <div class="order-item-name">${item.product_name}</div>
                        <div class="order-item-qty">${item.product_dosage} • Qty: ${item.quantity}</div>
                    </div>
                    <div>$${(parseFloat(item.product_price) * parseInt(item.quantity)).toFixed(2)}</div>
                </div>
            `).join('');
            
            return `
                <div class="order-card" data-status="${order.status}" data-id="${order.id}" data-search="${order.id.toLowerCase()} ${order.customer_full_name.toLowerCase()} ${order.customer_pharmacy_name.toLowerCase()}">
                    <div class="order-status status-${order.status}">${statusText}</div>
                    <div class="order-header">
                        <h3 class="order-id">${order.id.substring(0, 8)}...</h3>
                        <p class="order-date">${formatDate(order.created_at)}</p>
                    </div>
                    <div class="order-body">
                        <div class="order-customer">
                            <div class="customer-avatar">${initials}</div>
                            <div class="customer-info">
                                <h4>${order.customer_full_name}</h4>
                                <p>${order.customer_pharmacy_name}</p>
                            </div>
                        </div>
                        <div class="order-items">
                            ${itemsHtml}
                        </div>
                        <div class="order-total">
                            <span>Total:</span>
                            <span>$${totalAmount}</span>
                        </div>
                    </div>
                    <div class="order-footer">
                        ${actions}
                    </div>
                </div>
            `;
        }

        // Filter and render orders
        function renderOrders(orders, limit = 3) {
            ordersContainer.innerHTML = '';
            viewMoreContainer.style.display = 'none';

            if (orders.length === 0) {
                ordersContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-box-open"></i>
                        </div>
                        <h3 class="empty-title">No Orders Found</h3>
                        <p class="empty-text">There are currently no orders matching your criteria.</p>
                    </div>
                `;
                return;
            }
            
            const ordersToDisplay = orders.slice(0, limit);
            ordersToDisplay.forEach(order => {
                ordersContainer.innerHTML += createOrderCard(order);
            });

            if (orders.length > limit) {
                viewMoreContainer.style.display = 'block';
            }
        }

        // Filter orders based on search and status
        function filterOrders() {
            const searchTerm = searchInput.value.toLowerCase();
            const statusFilterValue = statusFilter.value;
            
            const filtered = allOrders.filter(order => {
                const matchesStatus = statusFilterValue === 'all' || order.status === statusFilterValue;
                const matchesSearch = 
                    order.id.toLowerCase().includes(searchTerm) ||
                    order.customer_full_name.toLowerCase().includes(searchTerm) ||
                    order.customer_pharmacy_name.toLowerCase().includes(searchTerm);
                
                return matchesStatus && matchesSearch;
            });
            
            renderOrders(filtered);
        }

        // Fetch orders from API
        async function fetchOrders() {
            try {
                const response = await fetch('/pharmacy/orders/');
                if (!response.ok) {
                    throw new Error('Failed to fetch orders');
                }
                const orders = await response.json();
                return orders;
            } catch (error) {
                console.error('Error fetching orders:', error);
                showToast('Failed to load orders. Please try again.', 'error');
                return [];
            }
        }

        // Update order status
        async function updateOrderStatus(orderId, newStatus) {
            try {
                const response = await fetch(`/pharmacy/orders/${orderId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update order status');
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error updating order status:', error);
                throw error;
            }
        }

        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Initial load
        async function initialize() {
            allOrders = await fetchOrders();
            if (allOrders.length > 0) {
                renderOrders(allOrders);
            }
            
            // Set up event listeners
            searchInput.addEventListener('input', filterOrders);
            statusFilter.addEventListener('change', filterOrders);

            // Add an event listener for the "View All Orders" button
            document.getElementById('view-all-orders').addEventListener('click', (e) => {
                e.preventDefault();
                // This is a placeholder. In a real app, you would redirect the user.
                // For this example, we'll just show all orders.
                renderOrders(allOrders, allOrders.length);
                viewMoreContainer.style.display = 'none';
            });
        }

        // Initialize the page
        initialize();

        window.viewOrderDetails = function(orderId) {
            // Construct the detail page URL using Django's URL pattern
            const detailUrl = `/pharmacy/order/${orderId}/`;
            
            // Navigate to the detail page
            window.location.href = detailUrl;
            
            // Optional: Show a loading message (will be replaced by the redirect)
            showToast(`Loading order details...`, 'info');
        };

        window.confirmOrder = async function(orderId) {
            try {
                const updatedOrder = await updateOrderStatus(orderId, 'confirmed');
                showToast(`Order ${orderId.substring(0, 8)}... confirmed successfully`, 'success');
                
                // Refresh the orders from the updated list
                allOrders = allOrders.map(order => order.id === orderId ? updatedOrder : order);
                filterOrders();
            } catch (error) {
                showToast(`Failed to confirm order ${orderId.substring(0, 8)}...`, 'error');
            }
        };

        window.cancelOrder = async function(orderId) {
            if (!confirm('Are you sure you want to cancel this order?')) return;
            
            try {
                const updatedOrder = await updateOrderStatus(orderId, 'cancelled');
                showToast(`Order ${orderId.substring(0, 8)}... cancelled successfully`, 'success');
                
                // Refresh the orders from the updated list
                allOrders = allOrders.map(order => order.id === orderId ? updatedOrder : order);
                filterOrders();
            } catch (error) {
                showToast(`Failed to cancel order ${orderId.substring(0, 8)}...`, 'error');
            }
        };
    });
</script>
{% endblock script %}